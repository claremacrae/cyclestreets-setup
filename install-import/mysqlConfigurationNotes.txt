INTRODUCTION

This directory contains a suggested configuration file for mysql on www: my.cnf
Should be used on all machines - especially those for handling import.

Setting of the Server System Variables is decribed at 
http://dev.mysql.com/doc/refman/5.1/en/server-system-variables.html

MyISAM / InnoDB
The main `cyclestreets`, `planetExtractOSMyymmdd` and `routingYYMMDD` databases exclusively use `MYISAM` tables.
The blog does use `InnoDB`, so it cannot be deactivated.

APPARMOR

If apparmor is running, as it is on Ubuntu development laptop, (but not the debian servers), take heed of the following:

# * IMPORTANT
#   If you make changes to these settings and your system uses apparmor, you may
#   also need to also adjust /etc/apparmor.d/usr.sbin.mysqld.
#   Eg. on fabian (a development laptop running Ubuntu) these lines were added (to allow a symlink to the my.cnf, and to allow the symlinked file to be read, presumably):
# /usr/sbin/mysqld {
#    ...
#  /etc/mysql/*.cnf lr,
#  /websites/www/content/configuration/mysql/www/my.cnf r,
#    ...
# }


SETTINGS

These are the significant settings on www that should be applied to similarly specked machines (i.e. 8GB RAM)

# This should be set to about 20 - 50% of available memory. On our 8GB www machine a good size is probably 1G. (The default is only 16M is a performance killer.)  
key_buffer		= 1G

max_allowed_packet	= 16M
group_concat_max_len	= 50K

# These are quite big
query_cache_limit	= 1M
query_cache_size        = 50M

log_slow_queries	= /var/log/mysql/mysql-slow.log
long_query_time = 3

# Restart mysql then check these settings:
# mysql>
select @@key_buffer_size, @@query_cache_limit, @@query_cache_size, @@log_slow_queries, @@long_query_time, @@group_concat_max_len;

# The following setting was added following getting this error during an import run:
#     ERROR 1206 (HY000): The total number of locks exceeds the lock table size
# Even though the database did not contain any innodb tables, it did fix the problem with an update to text columns in a table with almost 9 million rows.
innodb_buffer_pool_size=64MB

CHARACTER SET

It is simplest (and quickest, due to no translation overhead) if all text uses the `utf8` character set and collation `utf8_unicode_ci` (case-insensitive).
Set these in the mysql server configuration so that the `osmosis` program which reads the OpenStreetMap planet extracts also uses this character set.
In `/etc/mysql/my.cnf`:

# Set default character set and collation
character_set_server=utf8
collation_server=utf8_unicode_ci

If this is not done they you will see question marks appearing in some of the street names.
A good test is:
http://www.openstreetmap.org/browse/way/68446075/
Privileged accounts can view it at
http://www.cyclestreets.net/browse/way/68446075/

USING

# Because of the different versions of mysql in use it is wise to check compatibility before using these.

# Park the old one
sudo mv /etc/mysql/my.cnf /etc/mysql/my.cnf.parked

# Link to the new
sudo ln -s /websites/www/content/configuration/mysql/www/my.cnf /etc/mysql/

# Restart mysql
sudo service mysql restart

End of document
